<!DOCTYPE html>
<html>
<head>
    <title>GOVMAP - Sea Level Stations</title>
    <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 500px; }
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 500px; 
            background: #f0f0f0;
            color: #333;
        }
        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 500px;
            background: #ffe6e6;
            color: #d00;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>Loading GovMap...</div>
    </div>
    <div id="map" style="display: none;"></div>
    <div id="error" class="error" style="display: none;">
        <div>
            <h3>GovMap Unavailable</h3>
            <p>Unable to load GovMap API or station data</p>
        </div>
    </div>
    <script>
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('map').style.display = 'none';
            document.getElementById('error').style.display = 'flex';
            console.error('GovMap Error:', message);
        }
        
        function showMap() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('map').style.display = 'block';
        }
        
        let mapInstance;
        let stationsData = [];
        let forecastData = [];
        
        window.onload = function() {
            try {
                if (typeof govmap === 'undefined') {
                    throw new Error('GovMap API not loaded');
                }
                
                govmap.token = "11aa3021-4ae0-4771-8ae0-df75e73fe73e";
                
                const convertToITM = (lon, lat) => {
                    const x = 219529 + (lon - 35.2045) * 111320 * Math.cos(lat * Math.PI / 180);
                    const y = 626907 + (lat - 31.7344) * 111320;
                    return { x: Math.round(x), y: Math.round(y) };
                };
                
                const displayAllMarkers = () => {
                    if (stationsData.length === 0 && forecastData.length === 0) return;
                    
                    const wkts = [];
                    const names = [];
                    const symbols = [];
                    const tooltips = [];
                    const bubbleHTMLParameters = [];
                    
                    // Add stations
                    stationsData.forEach((station) => {
                        wkts.push(`POINT(${station.x} ${station.y})`);
                        names.push(`station_${station.Station}`);
                        symbols.push({
                            url: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#2196F3"/></svg>'),
                            width: 32,
                            height: 32
                        });
                        tooltips.push(`${station.Station} - ${station.latest_value}m`);
                        bubbleHTMLParameters.push([
                            station.Station,
                            `<strong>Sea Level:</strong> ${station.latest_value} m`,
                            `<strong>Last Update:</strong> ${station.last_update}`,
                            `<strong>Coordinates:</strong> ${station.latitude.toFixed(4)}, ${station.longitude.toFixed(4)}`,
                            '',
                            ''
                        ]);
                    });
                    
                    // Add forecasts
                    forecastData.forEach((location) => {
                        const coords = location.coordinates;
                        const itm = convertToITM(coords.lng, coords.lat);
                        wkts.push(`POINT(${itm.x} ${itm.y})`);
                        names.push(`forecast_${location.name_eng}`);
                        symbols.push({
                            url: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#FF9800"/></svg>'),
                            width: 32,
                            height: 32
                        });
                        
                        const currentForecast = location.forecasts[0];
                        tooltips.push(`${location.name_eng} - Wave Forecast`);
                        bubbleHTMLParameters.push([
                            location.name_eng,
                            `<strong>Wave Height:</strong> ${currentForecast?.elements?.wave_height || 'N/A'}`,
                            `<strong>Sea Temperature:</strong> ${currentForecast?.elements?.sea_temperature || 'N/A'}Â°C`,
                            `<strong>Wind:</strong> ${currentForecast?.elements?.wind || 'N/A'}`,
                            `<div style="font-size: 12px; color: #7f8c8d; margin-top: 10px;"><strong>Forecast Period:</strong><br>${currentForecast?.from || 'N/A'} - ${currentForecast?.to || 'N/A'}</div>`,
                            ''
                        ]);
                    });
                    
                    govmap.displayGeometries({
                        wkts: wkts,
                        names: names,
                        geometryType: govmap.geometryType.POINT,
                        symbols: symbols,
                        clearExisting: true,
                        data: {
                            tooltips: tooltips,
                            bubbleHTML: `
                                <div style="font-family: Arial, sans-serif; padding: 15px; min-width: 250px;">
                                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;">{{0}}</h4>
                                    <div style="margin: 8px 0;">{{1}}</div>
                                    <div style="margin: 8px 0;">{{2}}</div>
                                    <div style="margin: 8px 0;">{{3}}</div>
                                    {{4}}
                                    {{5}}
                                </div>
                            `,
                            bubbleHTMLParameters: bubbleHTMLParameters
                        }
                    });
                };
                
                const fetchAndDisplayStations = (endDate) => {
                    fetch(`/stations/map?end_date=${endDate}`)
                        .then(response => response.json())
                        .then(data => {
                            if (!Array.isArray(data) || data.length === 0) {
                                throw new Error('No station data');
                            }
                            stationsData = data;
                            displayAllMarkers();
                            showMap();
                        })
                        .catch(error => showError('Failed: ' + error.message));
                };
                
                const fetchWaveForecast = () => {
                    fetch('/sea-forecast')
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.locations) {
                                forecastData = data.locations;
                                displayAllMarkers();
                            }
                        })
                        .catch(error => console.warn('Wave forecast fetch failed:', error));
                };
                
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'UPDATE_DATE') {
                        fetchAndDisplayStations(event.data.payload);
                    }
                });
                
                fetchAndDisplayStations('2025-09-02');
                fetchWaveForecast();
                
                mapInstance = govmap.createMap("map", {
                    token: govmap.token,
                    layers: [],
                    center: { x: 176505, y: 662250 },
                    zoom: 0,
                    basemap: '2'
                });
                
            } catch (error) {
                showError('Init failed: ' + error.message);
            }
        };
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'UPDATE_STATIONS') {
                stationsData = event.data.stations;
            }
        });
    </script>
</body>
</html>